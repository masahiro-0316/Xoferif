# requirements.md

> プロジェクト名: Firefox ブックマーク Web 管理アプリ
> バージョン: v1.0（正式確定版）
> 作成日: 2025-10-04 (JST)
> 参照関係: 本書 → `design.md` → `CONTRIBUTING.md` → `AGENTS.md`

---

## 0. 目的・背景

Firefox からエクスポートした JSON を取り込み、**フォルダ階層をタグのツリー**として再現・管理・検索できる Web アプリを提供する。重複 URL の検出・マージ、タグの再編（改名/移動/結合）を支援し、ブックマークの整理コストを最小化する。

---

## 1. スコープ

### 1.1 対象

* 入力データ: **Firefox ブックマーク JSON**（標準エクスポート）
* 対象オブジェクト: フォルダ（階層）、ブックマーク（URL・タイトル・メモ等）

### 1.2 提供機能（概要）

* JSON **インポート**（プレビュー→実行、差分マージ）
* フォルダ階層 → **タグツリー**自動生成（親子関係）
* ブックマーク **CRUD**、重複検出/マージ
* タグ管理（改名/移動/結合/削除、ツリー表示）
* 検索・フィルタ（キーワード＋タグ AND/OR、子孫タグ包含）
* JSON **エクスポート**（アプリ独自フォーマット、将来: Firefox互換検討）

### 1.3 非スコープ（v1）

* ブラウザへの自動書き戻し（Firefox 逆輸出）
* 複数ブラウザ（Chrome/Edge など）のネイティブ取り込み
* マルチテナントSaaS運用・外部同期

---

## 2. 前提・環境・制約

* 言語/ランタイム: **Python 3.12**
* フレームワーク: **Django 5.x**
* UI: **Bootstrap**（サーバサイド描画、Django Template）
* DB: **PostgreSQL 15+**（開発のみ SQLite 併用可、CI は Postgres 前提）
* テスト: **pytest**（`pytest-django`）
* インフラ: Docker/Compose（単一ノード想定）
* タイムゾーン: Asia/Tokyo（JST）
* 文字: UTF-8、日本語を第一級で扱う
* ライセンス/法務: 社内利用前提（外部公開時は OSS ライセンス要検討）

---

## 3. ステークホルダー

* エンドユーザー: 個人/小規模チームで大量のブックマークを整理したい利用者
* 管理者: アプリ設定・ユーザー/権限管理・バックアップ
* 開発/運用: SWE, SRE, AppSec, QA（AGENTS編成に準ずる）

---

## 4. 用語集

* **タグ**: フォルダから生成される分類子。親子関係を持つ。
* **タグパス**: `menu/開発/DevOps` のようなフルパス表現。
* **重複**: 正規化後の URL が同一である複数ブックマーク。
* **上位ルート**: `menu`, `toolbar`, `unfiled`, `mobile`（Firefox エクスポートのルート直下分類）

---

## 5. 機能要件（ユーザーストーリー＋受け入れ基準）

> 付番規則: FR-xx（Functional Requirement）

### FR-01 JSONインポート（プレビュー→実行）

**As a** ユーザー
**I want** Firefox JSON をアップロードし取り込み可否を確認してから実行
**So that** 誤った取り込みを未然に防げる

**受け入れ基準**

* [ ] JSON をフォームからアップロードできる（MIME/拡張子/サイズ検証）
* [ ] **プレビュー**で件数統計（フォルダ/ブックマーク/新規タグ/既存マージ/重複候補）を表示
* [ ] **実行**時は取り込み結果（作成/更新/スキップ/エラー）を一覧化
* [ ] エラーは**行/キー/理由**を含む人間に読めるメッセージで表示
* [ ] 取り込み操作は監査ログ（History）に記録

### FR-02 フォルダ階層→タグツリー化（最重要）

**As a** ユーザー
**I want** フォルダ階層を**タグのツリー**として登録
**So that** 既存階層をそのまま分類に使える

**受け入れ基準**

* [ ] ルート直下の `menu/toolbar/unfiled/mobile` を上位タグとして取り込む（表示ON/OFF設定あり）
* [ ] 各フォルダをタグとして作成し、**親子関係**を保持
* [ ] ブックマークには**所属パスのすべてのタグ**を付与（親〜子まで）
* [ ] 既存タグと重複する場合は**マージ**し、重複作成しない
* [ ] タグ名は日本語/記号も保持、スラッグは自動生成
* [ ] 取り込み後、タグの増減やマージ件数が統計に反映

### FR-03 タグ管理（改名/移動/結合/削除）

**受け入れ基準**

* [ ] ツリー表示（折り畳み、件数バッジ、検索）
* [ ] タグの**改名/親変更**が可能（パスキャッシュも更新）
* [ ] タグの**結合（merge）**でブックマークの紐付けを統合
* [ ] タグ削除時、子/ブックマークの扱いを**選択**（昇格/一括削除/他へ移動）
* [ ] すべての操作は History に記録（実行者/差分）

### FR-04 ブックマーク管理（CRUD＋重複マージ）

**受け入れ基準**

* [ ] 一覧（ページング、並べ替え、検索）
* [ ] 詳細（タイトル、URL、説明、付与タグ、作成/更新日、履歴）
* [ ] 追加/編集/削除（CSRF 保護）
* [ ] 重複検出: **URL 正規化**後のハッシュで同一候補を提示、**マージ UI** を提供
* [ ] タグの付け外し（複数可）

### FR-05 検索・フィルタ

**受け入れ基準**

* [ ] キーワード検索（タイトル/説明/URL）
* [ ] タグフィルタ: AND/OR、**子孫タグの包含オプション**
* [ ] ブレッドクラムで現在のタグパスを表示

### FR-06 エクスポート

**受け入れ基準**

* [ ] アプリ独自 JSON でエクスポート（タグパス等のメタを含む）
* [ ] 将来: Firefox 互換形式の再生成は別リリースで検討

### FR-07 認証・権限

**受け入れ基準**

* [ ] ローカルユーザー認証（Django 標準）
* [ ] 権限ロール: **Admin / Editor / Viewer**
* [ ] 権限に応じた UI/エンドポイントの制御がある

---

## 6. 非機能要件

> 付番規則: NFR-xx（Non-Functional Requirement）

### NFR-01 性能・スケール

* 目標:

  * タグツリー初回レンダリング: **< 1.5s**（ノード ~1,000 で目安）
  * 検索/一覧応答: **< 500ms**（インデックス活用）
  * インポート: 失敗時はロールバック整合を保つ
* チューニング: 遅延読み込み/仮想リスト、必要に応じて FTS/trigram

### NFR-02 可用性・運用性

* デプロイ: Docker/Compose 単一ノード
* バックアップ: 日次 DB ダンプ
* ヘルスチェック: `/healthz`（DB 接続・マイグレーション状態）

### NFR-03 セキュリティ

* Web: CSRF、XSS（テンプレート自動エスケープ）、クリックジャッキング対策、CSP（`script-src 'self'`）
* パスワード: PBKDF2（将来 Argon2 切替可能）
* 入力検証: ファイル種別/サイズ/JSON スキーマ、URL 正規化
* 監査: 認証イベント・インポート/エクスポート・タグ/ブックマーク変更を History に記録
* シークレット: 環境変数/Secret Manager（リポジトリへの直書き禁止）

### NFR-04 可観測性

* 構造化ログ（JSON、request_id）
* メトリクス: HTTP レイテンシ/エラー率、インポート件数・失敗率、タグ操作件数
* 重要操作は History にもイベントとして保存

### NFR-05 信頼性・整合性

* DB トランザクションで**インポートを原子化**（部分失敗時はロールバック or スキップ戦略を明示）
* **Idempotency**: 同一 JSON の再取り込み時、**差分のみ**を更新できること

---

## 7. DevSecOps 要件

### 7.1 CI/CD（既存の `ci.yml` に準拠）

* Lint/Format/Type: **Ruff / Black / mypy**
* SAST/テンプレート/依存: **Bandit / djLint / pip-audit / detect-secrets**
* Django: `makemigrations --check`、（導入時）migration linter、`check --deploy`
* Test: **pytest**（PostgreSQL サービス起動、必要なら `--reuse-db`）
* 成果物: テスト/カバレッジレポート（将来: SBOM/CycloneDX）

### 7.2 pre-commit（既存の設定に準拠）

* コミット前に Ruff/Black/mypy/Bandit/djLint/pip-audit/detect-secrets を実行
* Docstring/行長の検査は Ruff（D 規則）を基本、必要に応じ pydocstyle 併用可

### 7.3 セキュリティ例外（Waiver）

* 期限・根拠・再評価日を必須とし、Issue に記録

---

## 8. データモデル（要件レベル）

> 実体は `design.md` で詳細化

* **bookmark**

  * `id (uuid)`, `title`, `url`, `url_norm_hash`, `description?`,
    `source_guid?`, `source_path`, `created_at`, `updated_at`
* **tag**（自己参照ツリー: MPTT 前提）

  * `id (uuid)`, `name`, `slug`, `parent_id?`, `path_cache`,
    `lft`, `rgt`, `level`, `created_at`, `updated_at`
* **bookmark_tag**（多対多）

  * `bookmark_id`, `tag_id`（複合PK）
* **history**（監査）

  * `id`, `actor_id`, `entity_type`, `entity_id`, `action`, `payload(jsonb)`, `created_at`

**必須制約（抽象）**

* Tag: `(parent_id, name)` 一意
* Bookmark: `url_norm_hash` はユニーク（重複排除のための選択制、運用方針で切替可）

---

## 9. インポート仕様（Firefox JSON → タグ/ブックマーク）

### 9.1 前提

* Firefox エクスポートが持つルート: `placesRoot` 配下の `menu/toolbar/unfiled/mobile`
* フォルダとブックマークの入れ子構造を再帰走査

### 9.2 マッピング

* **タグ生成**: フォルダごとに Tag を upsert（`(parent, name)` で一意）
* **タグ付与**: 各ブックマークに**所属パス上のすべてのタグ**を付与（親→子）
* **URL 正規化**: スキーム正規化、小文字化、末尾 `/` 除去、`#`・UTM 等の追尾除去
* **重複**: `url_norm_hash` で検出。設定により「スキップ/更新/マージ」を選択
* **統計**: 作成/更新/スキップ/タグ新規/タグマージ/重複候補を算出
* **トランザクション**: 実行単位で原子性を担保

---

## 10. UI/UX 要件

* レイアウト: 左ペイン＝**タグツリー**、右ペイン＝一覧/詳細（Bootstrap）
* **タグツリー**: 折り畳み、件数バッジ、コンテキストメニュー（改名/移動/結合/削除）
* **ブレッドクラム**: 現在のタグパスを表示
* 一覧: ページング・並べ替え・キーワード検索・タグフィルタ（AND/OR・子孫包含）
* 詳細: メタ情報・付与タグ・同一URL候補・履歴
* アクセシビリティ: キーボード操作、フォーカス可視化、日本語ラベル

---

## 11. コーディング規約（本プロジェクト統一）

* **整形/静的解析**: Black / Ruff / mypy / Bandit / djLint / pip-audit / detect-secrets
* **行長**: **原則 88 文字以内**（Black 基準）
* **単一責任**: **1関数1機能**（副作用分離、早期 return、深いネスト禁止）
* **型**: すべての公開関数に型注釈を付与
* **Docstring/コメント**:

  * すべての**関数・クラスに Docstring 必須**（Google スタイル推奨）
  * **初心者にも理解できる**平易な日本語で、**「なぜそうするか」**を重視
  * **処理単位でコメント**を付与（前提・制約・副作用・注意点）
  * 参照 Issue や背景資料があればリンク/番号を残す

---

## 12. 監査・ログ・バックアップ

* **History**: ログイン、インポート、タグ操作、ブックマーク CRUD、エクスポート等を保存
* **構造化ログ**: JSON、request_id 付与
* **バックアップ**: 日次 `pg_dump`、復元手順は Runbook に記載

---

## 13. リスクと対応

| リスク        | 影響     | 対応                     |
| ---------- | ------ | ---------------------- |
| 巨大ツリーの描画遅延 | UX 低下  | 遅延読み込み/仮想リスト、クエリ最適化    |
| URL 正規化差異  | 重複検出ミス | ルールをユニットテストで固定・回帰テスト   |
| タグ結合の誤操作   | データ損失  | 確認モーダル＋History からの復旧手順 |
| インポート中断    | 整合性欠如  | トランザクション・リトライ・再実行で冪等   |

---

## 14. 受け入れテスト（高レベル）

* **インポート/E2E**: 代表 JSON を用意し、プレビュー→実行で

  * タグツリーが**重複なしで**生成
  * 任意ブックマークに**親〜子の全タグ**が付与
  * 重複 URL 候補が検出され、マージ UI が動作
* **検索/フィルタ**: AND/OR、子孫包含の正しさ
* **権限**: Admin/Editor/Viewer で画面・操作が適切に制御
* **性能**: 仕様の応答目標を満たす

---

## 15. 変更管理

* 本書は**正規版 v1**として確定。以降の変更は Issue+PR で行い、**変更履歴**に追記。
* 設計・実装で矛盾が生じた場合、**本書を優先**し速やかに `design.md` を更新。

---
